name: Build

on:
  pull_request:
    branches:
      - main
      - uat
      - dev

jobs:
  build:
    name: Build and analyze
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Set up JDK 17
        uses: actions/setup-java@v1
        with:
          java-version: 21
      - name: Build and analyze
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          cd apex-airline-system/backend
          ./gradlew build sonar --info
  
  notify:
    name: Notify on failure
    needs: build
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Execute cURL command to send mail
        run: |
          curl -X POST https://api.mailersend.com/v1/email \
          -H 'Content-Type: application/json' \
          -H 'X-Requested-With: XMLHttpRequest' \
          -H 'Authorization: Bearer mlsn.d76943fa47af8613d289ef360395b4eb9a47e5571ece88b2de9c3d57724b5bc1' \
          -d '{
              "from": {
                  "email": "MS_jeaiMD@trial-z3m5jgrwnqoldpyo.mlsender.net"
              },
              "to": [
                  {
                      "email": "mamarroquina@unis.edu.gt"
                  }
              ],
              "subject": "SonarQube Failure",
              "text": "Unfortunately, the SonarQube scan has failed.",
              "html": "Unfortunately, the SonarQube scan has failed."
          }'